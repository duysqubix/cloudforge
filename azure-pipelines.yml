trigger:
  branches:
    include:
      - master
pr:
  branches:
    include:
      - '*'
pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: CopyFiles@2
    displayName: "Copy EC source code"
    inputs:
      SourceFolder: .
      TargetFolder: '$(build.artifactstagingdirectory)/ecdeploy'

  - script: python -m pip install -r modules/requirements.txt
    displayName: "Install Dependencies"

  - task: GoTool@0
    inputs:
      version : '1.19.*'

  - task: Bash@3
    displayName: "Testing Code"
    inputs:
      targetType: 'inline'
      workingDirectory: '$(build.artifactstagingdirectory)/ecdeploy/'
      script: |
        go test ./... -v 

  - task: Bash@3
    displayName: "Compiling Deployment Engine"
    inputs:
      targetType: 'inline'
      workingDirectory: '$(build.artifactstagingdirectory)/ecdeploy/'
      script: |
        bash ./scripts/build.sh 

  - task: PublishBuildArtifacts@1
    displayName: "Publish binary"
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
    inputs:
      PathtoPublish: '$(build.artifactstagingdirectory)/ecdeploy/bin'
      ArtifactName: 'core'
      
